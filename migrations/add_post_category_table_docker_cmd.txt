# Command untuk menjalankan migration add_post_category_table di VPS
# Copy-paste command berikut ke terminal VPS:

# 1. Create table post_categories
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "CREATE TABLE IF NOT EXISTS post_categories (id SERIAL PRIMARY KEY, name VARCHAR(100) NOT NULL UNIQUE, display_name VARCHAR(100) NOT NULL, description TEXT, icon VARCHAR(100), is_active BOOLEAN DEFAULT TRUE NOT NULL, created_at TIMESTAMP DEFAULT NOW() NOT NULL, updated_at TIMESTAMP DEFAULT NOW() NOT NULL);"

# 2. Create indexes
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "CREATE INDEX IF NOT EXISTS idx_post_categories_name ON post_categories(name);"
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "CREATE INDEX IF NOT EXISTS idx_post_categories_is_active ON post_categories(is_active);"

# 3. Insert default categories
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "INSERT INTO post_categories (name, display_name, description, is_active) VALUES ('kesehatan', 'Kesehatan', 'Diskusi tentang kesehatan ibu hamil', TRUE), ('nutrisi', 'Nutrisi', 'Diskusi tentang nutrisi dan makanan sehat untuk ibu hamil', TRUE), ('persiapan', 'Persiapan', 'Diskusi tentang persiapan kelahiran dan kehamilan', TRUE), ('curhat', 'Curhat', 'Ruang untuk berbagi cerita dan pengalaman', TRUE), ('tips', 'Tips', 'Tips dan saran untuk ibu hamil', TRUE), ('tanya_jawab', 'Tanya Jawab', 'Tanya jawab seputar kehamilan', TRUE) ON CONFLICT (name) DO NOTHING;"

# 4. Add category_id column to posts (with default value)
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "ALTER TABLE posts ADD COLUMN IF NOT EXISTS category_id INTEGER;"

# 5. Set default value for existing posts
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "UPDATE posts SET category_id = (SELECT id FROM post_categories WHERE name = 'tanya_jawab' LIMIT 1) WHERE category_id IS NULL;"

# 6. Make category_id NOT NULL
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "ALTER TABLE posts ALTER COLUMN category_id SET NOT NULL;"

# 7. Add foreign key constraint
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "ALTER TABLE posts ADD CONSTRAINT IF NOT EXISTS fk_posts_category FOREIGN KEY (category_id) REFERENCES post_categories(id) ON DELETE RESTRICT;"

# 8. Create indexes for category_id
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "CREATE INDEX IF NOT EXISTS idx_posts_category_id ON posts(category_id);"
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "CREATE INDEX IF NOT EXISTS idx_post_category_created ON posts(category_id, created_at);"

# 9. Verify (optional)
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "SELECT * FROM post_categories;"
docker exec wellmom_postgres psql -U wellmom -d wellmom_db -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'posts' AND column_name = 'category_id';"
